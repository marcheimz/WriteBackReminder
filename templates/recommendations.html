<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>WriteBackReminder â€“ Follow-up suggestions</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body data-user-email="{{ active_user_email }}" data-selected-person="" class="min-h-screen bg-slate-100 text-slate-900">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 py-10">
      <header class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h1 class="text-3xl font-semibold text-slate-900">Follow-up suggestions</h1>
          <p class="mt-1 text-sm text-slate-600">
            Logged in as {{ active_user_name or active_user_email }}
            {% if active_user_name and active_user_email and active_user_name != active_user_email %}
            ({{ active_user_email }})
            {% endif %}
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          {% set is_refreshing = refresh_in_progress|default(False) %}
          <form
            method="post"
            action="{{ url_for('refresh_recommendations') }}"
            class="refresh-form"
            data-refresh-endpoint="{{ url_for('refresh_recommendations_api') }}"
            data-status-endpoint="{{ url_for('refresh_recommendations_status') }}"
          >
            <button
              type="submit"
              class="loading-button inline-flex h-10 w-44 items-center justify-center rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:bg-slate-200 disabled:text-slate-400"
              data-loading-label="Refreshing"
              data-default-label="Refresh follow-ups"
              data-refreshing="{{ 'true' if is_refreshing else 'false' }}"
              {% if is_refreshing %}disabled{% endif %}
            >
              {% if is_refreshing %}Refreshing ...{% else %}Refresh follow-ups{% endif %}
            </button>
          </form>
          <a
            href="{{ url_for('conversations') }}"
            class="inline-flex h-10 items-center rounded-md border border-slate-300 bg-white px-4 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100"
          >
            Back to conversations
          </a>
          <form method="post" action="{{ url_for('logout') }}">
            <button
              type="submit"
              class="inline-flex h-10 items-center rounded-md border border-rose-200 bg-rose-500 px-3 text-sm font-semibold text-white shadow-sm transition hover:bg-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-300"
            >
              Switch user
            </button>
          </form>
        </div>
      </header>

      <div class="h-5 text-sm text-slate-500" data-refresh-status role="status" aria-live="polite"></div>

      <div data-recommendations-container class="rounded-2xl border border-slate-200 bg-white shadow-sm">
        {% if recommendations %}
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
            <tr>
              <th scope="col" class="px-4 py-3">Person</th>
              <th scope="col" class="px-4 py-3">Urgency</th>
              <th scope="col" class="px-4 py-3">Proposed response</th>
              <th scope="col" class="px-4 py-3">Rationale</th>
              <th scope="col" class="px-4 py-3">Generated</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200 text-sm text-slate-700">
            {% for person, rec in recommendations %}
            {% set urgency_class = 'text-rose-600' if rec.urgency >= 8 else ('text-amber-600' if rec.urgency >= 5 else 'text-emerald-600') %}
            <tr class="odd:bg-white even:bg-slate-50">
              <td class="px-4 py-3 font-medium text-slate-800">
                <a href="{{ url_for('conversations', person=person) }}" class="text-sky-600 hover:underline">
                  {{ person }}
                </a>
              </td>
              <td class="px-4 py-3 font-semibold {{ urgency_class }}">{{ rec.urgency }}/10</td>
              <td class="px-4 py-3 text-slate-700">{{ rec.proposed_response }}</td>
              <td class="px-4 py-3 text-slate-600">{{ rec.rationale }}</td>
              <td class="px-4 py-3 text-xs uppercase tracking-wide text-slate-500">
                {{ rec.generated_at.strftime('%Y-%m-%d %H:%M UTC') }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="px-4 py-6 text-sm text-slate-500">No follow-up suggestions generated yet. Log conversations to see recommendations here.</p>
        {% endif %}
      </div>

      <div data-recommendation-container class="hidden"></div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const refreshForms = document.querySelectorAll('.refresh-form');
        if (!refreshForms.length) {
          return;
        }

        const statusEl = document.querySelector('[data-refresh-status]');
        const listContainer = document.querySelector('[data-recommendations-container]');
        const cardContainer = document.querySelector('[data-recommendation-container]');
        const selectedPerson = (document.body.dataset.selectedPerson || '').trim();
        const frames = ['.', '..', '...'];
        const intervals = new WeakMap();
        const POLL_INTERVAL_MS = 2500;

        const setStatus = (message, isError = false) => {
          if (!statusEl) {
            return;
          }
          statusEl.textContent = '';
          if (isError && message) {
            console.error(message);
          }
        };

        const startAnimation = (button) => {
          if (!button || intervals.has(button)) {
            return;
          }
          const defaultLabel = button.dataset.defaultLabel || button.textContent.trim() || 'Refresh follow-ups';
          button.dataset.defaultLabel = defaultLabel;
          button.dataset.animating = 'true';
          button.dataset.refreshing = 'true';
          const baseLabel = button.dataset.loadingLabel || 'Refreshing';
          let frameIndex = 0;
          const updateLabel = () => {
            button.textContent = `${baseLabel} ${frames[frameIndex]}`;
            frameIndex = (frameIndex + 1) % frames.length;
          };
          button.disabled = true;
          updateLabel();
          const intervalId = window.setInterval(updateLabel, 350);
          intervals.set(button, intervalId);
        };

        const stopAnimation = (button) => {
          if (!button) {
            return;
          }
          if (intervals.has(button)) {
            const id = intervals.get(button);
            window.clearInterval(id);
            intervals.delete(button);
          }
          button.dataset.animating = 'false';
          button.dataset.refreshing = 'false';
          const defaultLabel = button.dataset.defaultLabel || 'Refresh follow-ups';
          button.textContent = defaultLabel;
          button.disabled = false;
        };

        const renderRecommendationsTable = (items) => {
          if (!listContainer) {
            return;
          }
          listContainer.innerHTML = '';
          if (!items.length) {
            const empty = document.createElement('p');
            empty.className = 'text-sm text-slate-500';
            empty.textContent = 'No follow-up suggestions generated yet. Log conversations to see recommendations here.';
            listContainer.appendChild(empty);
            return;
          }

          const table = document.createElement('table');
          table.className = 'min-w-full overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm';
          const thead = document.createElement('thead');
          thead.className = 'bg-slate-50';
          const headRow = document.createElement('tr');
          headRow.className = 'text-left text-xs font-semibold uppercase tracking-wide text-slate-500';
          ['Person', 'Urgency', 'Proposed response', 'Rationale', 'Generated'].forEach((label) => {
            const th = document.createElement('th');
            th.textContent = label;
            th.className = 'px-4 py-3';
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          tbody.className = 'divide-y divide-slate-200 text-sm text-slate-700';
          items.forEach((item) => {
            const row = document.createElement('tr');
            row.className = 'odd:bg-white even:bg-slate-50';

            const personCell = document.createElement('td');
            if (item.conversation_url) {
              const link = document.createElement('a');
              link.href = item.conversation_url;
              link.textContent = item.person;
              link.className = 'text-sky-600 hover:underline';
              personCell.appendChild(link);
            } else {
              personCell.textContent = item.person;
            }
            personCell.className = 'px-4 py-3 font-medium text-slate-800';
            row.appendChild(personCell);

            const urgencyCell = document.createElement('td');
            const urgencyClass =
              item.urgency >= 8
                ? 'text-rose-600'
                : item.urgency >= 5
                ? 'text-amber-600'
                : 'text-emerald-600';
            urgencyCell.className = `px-4 py-3 font-semibold ${urgencyClass}`;
            urgencyCell.textContent = `${item.urgency}/10`;
            row.appendChild(urgencyCell);

            const responseCell = document.createElement('td');
            responseCell.className = 'px-4 py-3 text-slate-700';
            responseCell.textContent = item.proposed_response;
            row.appendChild(responseCell);

            const rationaleCell = document.createElement('td');
            rationaleCell.className = 'px-4 py-3 text-slate-600';
            rationaleCell.textContent = item.rationale;
            row.appendChild(rationaleCell);

            const timestampCell = document.createElement('td');
            timestampCell.className = 'px-4 py-3 text-xs uppercase tracking-wide text-slate-500';
            timestampCell.textContent = item.generated_label || item.generated_at;
            row.appendChild(timestampCell);

            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          listContainer.appendChild(table);
        };

        const renderSelectedRecommendation = (items) => {
          if (!cardContainer || !selectedPerson) {
            return;
          }
          cardContainer.innerHTML = '';
          const match = items.find((item) => item.person === selectedPerson);
          if (!match) {
            const message = document.createElement('p');
            message.className = 'text-sm text-slate-500';
            message.textContent = 'No AI follow-up yet. Refresh to generate one.';
            cardContainer.appendChild(message);
            return;
          }

          const section = document.createElement('section');
          section.className = 'space-y-3 rounded-2xl border border-sky-200 bg-sky-50 p-6 shadow-sm';

          const title = document.createElement('h2');
          title.textContent = 'Suggested follow-up';
          title.className = 'text-lg font-semibold text-slate-900';
          section.appendChild(title);

          const urgency = document.createElement('p');
          urgency.className = 'text-sm font-semibold text-sky-800';
          urgency.textContent = `Urgency: ${match.urgency} / 10`;
          section.appendChild(urgency);

          const summary = document.createElement('p');
          summary.className = 'text-base text-slate-800';
          summary.textContent = match.proposed_response;
          section.appendChild(summary);

          const rationale = document.createElement('p');
          rationale.className = 'text-sm text-slate-700';
          const rationaleLabel = document.createElement('strong');
          rationaleLabel.textContent = 'Why:';
          rationale.appendChild(rationaleLabel);
          rationale.append(` ${match.rationale}`);
          section.appendChild(rationale);

          const generated = document.createElement('p');
          generated.className = 'text-xs uppercase tracking-wide text-slate-500';
          generated.textContent = `Generated ${match.generated_label || match.generated_at}`;
          section.appendChild(generated);

          cardContainer.appendChild(section);
        };

        const handleResponse = (payload) => {
          const list = Array.isArray(payload?.recommendations) ? payload.recommendations : [];
          renderRecommendationsTable(list);
          renderSelectedRecommendation(list);
        };

        refreshForms.forEach((form) => {
          if (form.dataset.bound === 'true') {
            return;
          }
          form.dataset.bound = 'true';

          const endpoint = form.dataset.refreshEndpoint;
          const statusEndpoint = form.dataset.statusEndpoint;
          const button = form.querySelector('button');
          if (!endpoint || !statusEndpoint || !button) {
            return;
          }

          let pollTimer = null;
          let lastStart = 0;

          const cancelPoll = () => {
            if (pollTimer) {
              window.clearTimeout(pollTimer);
              pollTimer = null;
            }
          };

          const pollStatus = async () => {
            try {
              const response = await fetch(statusEndpoint, {
                method: 'GET',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
                cache: 'no-store',
              });
              if (!response.ok) {
                throw new Error(`Status request failed: ${response.status}`);
              }
              const payload = await response.json();
              const inProgress = Boolean(payload?.refresh_in_progress);
              button.dataset.refreshing = inProgress ? 'true' : 'false';
              handleResponse(payload);
              if (inProgress) {
                setStatus(payload?.message || 'Refreshing follow-upsâ€¦');
                pollTimer = window.setTimeout(pollStatus, POLL_INTERVAL_MS);
              } else {
                if (Date.now() - lastStart < POLL_INTERVAL_MS) {
                  pollTimer = window.setTimeout(pollStatus, 250);
                  return;
                }
                stopAnimation(button);
                cancelPoll();
                setStatus(payload?.message || 'Recommendations refreshed.', false);
              }
            } catch (error) {
              console.error('Failed to poll refresh status', error);
              stopAnimation(button);
              cancelPoll();
              setStatus('Failed to refresh follow-ups. Please try again.', true);
            }
          };

          const ensurePolling = () => {
            if (!pollTimer) {
              pollTimer = window.setTimeout(pollStatus, 0);
            }
          };

          if (button.dataset.refreshing === 'true') {
            startAnimation(button);
            lastStart = Date.now();
            ensurePolling();
          }

          form.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (intervals.has(button)) {
              return;
            }

            startAnimation(button);
            setStatus('Refreshing follow-upsâ€¦');
            lastStart = Date.now();
            ensurePolling();

            try {
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
              });

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || response.statusText);
              }

              const payload = await response.json();
              handleResponse(payload);
              const inProgress = Boolean(payload?.refresh_in_progress);
              button.dataset.refreshing = inProgress ? 'true' : 'false';
              const message = payload?.message || (inProgress ? 'Refreshing follow-upsâ€¦' : 'Recommendations refreshed.');
              setStatus(message, false);
              if (!inProgress) {
                stopAnimation(button);
                cancelPoll();
              } else {
                lastStart = Date.now();
                ensurePolling();
              }
            } catch (error) {
              console.error('Failed to refresh follow-ups', error);
              setStatus('Failed to refresh follow-ups. Please try again.', true);
              stopAnimation(button);
              cancelPoll();
            }
          });
        });
      });
    </script>
  </body>
</html>
