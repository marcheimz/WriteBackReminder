<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>WriteBackReminder</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body data-user-email="{{ active_user_email }}" data-selected-person="{{ selected_person or '' }}" class="min-h-screen bg-slate-100 text-slate-900">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 py-10">
      <header class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h1 class="text-3xl font-semibold text-slate-900">WriteBackReminder</h1>
          <p class="mt-1 text-sm text-slate-600">
            Logged in as {{ active_user_name or active_user_email }}
            {% if active_user_name and active_user_email and active_user_name != active_user_email %}
            ({{ active_user_email }})
            {% endif %}
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          {% set is_refreshing = refresh_in_progress|default(False) %}
          <form
            method="post"
            action="{{ url_for('refresh_recommendations') }}"
            class="refresh-form"
            data-refresh-endpoint="{{ url_for('refresh_recommendations_api') }}"
            data-status-endpoint="{{ url_for('refresh_recommendations_status') }}"
          >
            <button
              type="submit"
              class="loading-button inline-flex h-10 w-44 items-center justify-center rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:bg-slate-200 disabled:text-slate-400"
              data-loading-label="Refreshing"
              data-default-label="Refresh follow-ups"
              data-refreshing="{{ 'true' if is_refreshing else 'false' }}"
              {% if is_refreshing %}disabled{% endif %}
            >
              {% if is_refreshing %}Refreshing ...{% else %}Refresh follow-ups{% endif %}
            </button>
          </form>
          <a
            href="{{ url_for('recommendations_page') }}"
            class="inline-flex h-10 items-center rounded-md border border-slate-300 bg-white px-4 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-100"
          >
            Follow-up suggestions
          </a>
          <form method="post" action="{{ url_for('logout') }}">
            <button
              type="submit"
              class="inline-flex h-10 items-center rounded-md border border-rose-200 bg-rose-500 px-3 text-sm font-semibold text-white shadow-sm transition hover:bg-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-300"
            >
              Switch user
            </button>
          </form>
        </div>
      </header>

      <div class="h-5 text-sm text-slate-500" data-refresh-status role="status" aria-live="polite"></div>

      {% if errors %}
      <div class="rounded-xl border border-rose-200 bg-rose-50 p-4 text-rose-800 shadow-sm">
        <ul class="list-disc space-y-1 pl-5 text-sm">
          {% for error in errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Known contacts</h2>
        {% if known_people %}
        <div class="mt-3 flex flex-wrap gap-2">
          {% for person in known_people %}
          <a
            href="{{ url_for('conversations', person=person) }}"
            class="inline-flex items-center rounded-full border border-slate-300 px-3 py-1 text-sm {% if person == selected_person %}bg-slate-900 font-medium text-white{% else %}bg-white text-slate-700 hover:bg-slate-100{% endif %}"
          >
            {{ person }}
          </a>
          {% endfor %}
        </div>
        {% else %}
        <p class="mt-3 text-sm text-slate-500">No past conversations yet.</p>
        {% endif %}
      </section>

      <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <form method="post" action="{{ url_for('log_conversation') }}" id="log-form" class="flex flex-col gap-4">
          <div class="flex flex-col gap-2">
            <label for="person" class="text-sm font-semibold text-slate-700">Who did you speak with?</label>
            <input
              type="text"
              id="person"
              name="person"
              list="known-people"
              value="{{ selected_person or '' }}"
              placeholder="Type a name"
              autocomplete="off"
              required
              class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200"
            />
            <datalist id="known-people">
              {% for person in known_people %}
              <option value="{{ person }}">{{ person }}</option>
              {% endfor %}
            </datalist>
          </div>

          <div class="flex flex-col gap-2">
            <label for="entry-type" class="text-sm font-semibold text-slate-700">Entry type</label>
            {% set selected_type = new_entry_type|default('conversation') %}
            <select
              id="entry-type"
              name="entry_type"
              class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200"
            >
              <option value="conversation" {% if selected_type != 'note' %}selected{% endif %}>Conversation</option>
              <option value="note" {% if selected_type == 'note' %}selected{% endif %}>Note</option>
            </select>
          </div>

          <div class="flex flex-col gap-2">
            <label for="summary" class="text-sm font-semibold text-slate-700">Details</label>
            <textarea
              id="summary"
              name="summary"
              placeholder="What was discussed?"
              required
              class="w-full min-h-[7rem] rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-200"
            >{{ draft_summary or '' }}</textarea>
          </div>

          <div class="flex justify-end">
            <button
              type="submit"
              class="inline-flex items-center rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-300"
            >
              Log conversation
            </button>
          </div>
        </form>
      </section>

      <div data-recommendation-container class="space-y-4">
        {% if recommendation %}
        <section class="rounded-2xl border border-sky-200 bg-sky-50 p-6 shadow-sm">
          <h2 class="text-lg font-semibold text-slate-900">Suggested follow-up</h2>
          <p class="mt-2 text-sm font-semibold text-sky-800">Urgency: {{ recommendation.urgency }} / 10</p>
          <p class="mt-2 text-base text-slate-800">{{ recommendation.proposed_response }}</p>
          <p class="mt-3 text-sm text-slate-700"><strong>Why:</strong> {{ recommendation.rationale }}</p>
          <p class="mt-2 text-xs uppercase tracking-wide text-slate-500">Generated {{ recommendation.generated_at.strftime('%Y-%m-%d %H:%M UTC') }}</p>
        </section>
        {% elif selected_person %}
        <p class="text-sm text-slate-500">No AI follow-up yet. Refresh to generate one.</p>
        {% endif %}
      </div>

      {% if selected_person %}
      <section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Conversation history with {{ selected_person }}</h2>
        {% if conversations %}
          {% for entry in conversations|reverse %}
          {% set is_note = entry.entry_type == 'note' %}
          <article class="rounded-xl border px-4 py-3 shadow-sm {% if is_note %}border-amber-200 bg-amber-50{% else %}border-slate-200 bg-white{% endif %}">
            <time class="text-xs uppercase tracking-wide text-slate-500" datetime="{{ entry.timestamp.isoformat() }}">
              {{ entry.timestamp.strftime('%Y-%m-%d %H:%M UTC') }}
            </time>
            {% if is_note %}
            <p class="mt-2 text-sm text-slate-800"><strong>Note:</strong> {{ entry.summary }}</p>
            {% else %}
            <p class="mt-2 text-sm text-slate-800">{{ entry.summary }}</p>
            {% endif %}
            <div class="mt-3 flex flex-wrap items-center gap-2">
              <a
                href="{{ url_for('edit_entry', person=selected_person, entry=entry.id) }}"
                class="inline-flex items-center rounded-md border border-slate-300 bg-white px-3 py-1 text-xs font-medium text-slate-700 shadow-sm transition hover:bg-slate-100"
              >
                Edit
              </a>
              <form method="post" action="{{ url_for('delete_entry') }}" onsubmit="return confirm('Delete this entry?');">
                <input type="hidden" name="person" value="{{ selected_person }}" />
                <input type="hidden" name="entry_id" value="{{ entry.id }}" />
                <button
                  type="submit"
                  class="inline-flex items-center rounded-md border border-rose-200 bg-white px-3 py-1 text-xs font-medium text-rose-600 shadow-sm transition hover:bg-rose-50"
                >
                  Delete
                </button>
              </form>
            </div>
          </article>
          {% endfor %}
        {% else %}
        <p class="text-sm text-slate-500">No conversations logged yet. Add a summary above to get started.</p>
        {% endif %}
      </section>
      {% endif %}
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const body = document.body;
        const userEmail = body.dataset.userEmail;

        const logForm = document.getElementById('log-form');
        if (logForm) {
          const typeSelect = logForm.querySelector('#entry-type');
          const summaryField = logForm.querySelector('#summary');
          if (typeSelect && summaryField) {
            const placeholders = {
              conversation: 'What was discussed?',
              note: 'What do you want to remember or plan?'
            };
            const updatePlaceholder = () => {
              const key = (typeSelect.value || 'conversation').toLowerCase();
              summaryField.placeholder = placeholders[key] || placeholders.conversation;
            };
            updatePlaceholder();
            typeSelect.addEventListener('change', updatePlaceholder);
          }
        }

        const refreshForms = document.querySelectorAll('.refresh-form');
        if (!refreshForms.length) {
          return;
        }

        const statusEl = document.querySelector('[data-refresh-status]');
        const listContainer = document.querySelector('[data-recommendations-container]');
        const cardContainer = document.querySelector('[data-recommendation-container]');
        const selectedPerson = (document.body.dataset.selectedPerson || '').trim();
        const frames = ['.', '..', '...'];
        const intervals = new WeakMap();
        const POLL_INTERVAL_MS = 2500;

        const setStatus = (message, isError = false) => {
          if (!statusEl) {
            return;
          }
          statusEl.textContent = '';
          if (isError && message) {
            console.error(message);
          }
        };

        const startAnimation = (button) => {
          if (!button || intervals.has(button)) {
            return;
          }
          const defaultLabel = button.dataset.defaultLabel || button.textContent.trim() || 'Refresh follow-ups';
          button.dataset.defaultLabel = defaultLabel;
          button.dataset.animating = 'true';
          button.dataset.refreshing = 'true';
          const baseLabel = button.dataset.loadingLabel || 'Refreshing';
          let frameIndex = 0;
          const updateLabel = () => {
            button.textContent = `${baseLabel} ${frames[frameIndex]}`;
            frameIndex = (frameIndex + 1) % frames.length;
          };
          button.disabled = true;
          updateLabel();
          const intervalId = window.setInterval(updateLabel, 350);
          intervals.set(button, intervalId);
        };

        const stopAnimation = (button) => {
          if (!button) {
            return;
          }
          if (intervals.has(button)) {
            const id = intervals.get(button);
            window.clearInterval(id);
            intervals.delete(button);
          }
          button.dataset.animating = 'false';
          button.dataset.refreshing = 'false';
          const defaultLabel = button.dataset.defaultLabel || 'Refresh follow-ups';
          button.textContent = defaultLabel;
          button.disabled = false;
        };

        const renderRecommendationsTable = (items) => {
          if (!listContainer) {
            return;
          }
          listContainer.innerHTML = '';
          if (!items.length) {
            const empty = document.createElement('p');
            empty.className = 'text-sm text-slate-500';
            empty.textContent = 'No follow-up suggestions generated yet. Log conversations to see recommendations here.';
            listContainer.appendChild(empty);
            return;
          }

          const table = document.createElement('table');
          table.className = 'min-w-full overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm';
          const thead = document.createElement('thead');
          thead.className = 'bg-slate-50';
          const headRow = document.createElement('tr');
          headRow.className = 'text-left text-xs font-semibold uppercase tracking-wide text-slate-500';
          ['Person', 'Urgency', 'Proposed response', 'Rationale', 'Generated'].forEach((label) => {
            const th = document.createElement('th');
            th.textContent = label;
            th.className = 'px-4 py-3';
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          tbody.className = 'divide-y divide-slate-200 text-sm text-slate-700';
          items.forEach((item) => {
            const row = document.createElement('tr');
            row.className = 'odd:bg-white even:bg-slate-50';

            const personCell = document.createElement('td');
            if (item.conversation_url) {
              const link = document.createElement('a');
              link.href = item.conversation_url;
              link.textContent = item.person;
              link.className = 'text-sky-600 hover:underline';
              personCell.appendChild(link);
            } else {
              personCell.textContent = item.person;
            }
            personCell.className = 'px-4 py-3 font-medium text-slate-800';
            row.appendChild(personCell);

            const urgencyCell = document.createElement('td');
            const urgencyClass =
              item.urgency >= 8
                ? 'text-rose-600'
                : item.urgency >= 5
                ? 'text-amber-600'
                : 'text-emerald-600';
            urgencyCell.className = `px-4 py-3 font-semibold ${urgencyClass}`;
            urgencyCell.textContent = `${item.urgency}/10`;
            row.appendChild(urgencyCell);

            const responseCell = document.createElement('td');
            responseCell.className = 'px-4 py-3 text-slate-700';
            responseCell.textContent = item.proposed_response;
            row.appendChild(responseCell);

            const rationaleCell = document.createElement('td');
            rationaleCell.className = 'px-4 py-3 text-slate-600';
            rationaleCell.textContent = item.rationale;
            row.appendChild(rationaleCell);

            const timestampCell = document.createElement('td');
            timestampCell.className = 'px-4 py-3 text-xs uppercase tracking-wide text-slate-500';
            timestampCell.textContent = item.generated_label || item.generated_at;
            row.appendChild(timestampCell);

            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          listContainer.appendChild(table);
        };

        const renderSelectedRecommendation = (items) => {
          if (!cardContainer || !selectedPerson) {
            return;
          }
          cardContainer.innerHTML = '';
          const match = items.find((item) => item.person === selectedPerson);
          if (!match) {
            const message = document.createElement('p');
            message.className = 'text-sm text-slate-500';
            message.textContent = 'No AI follow-up yet. Refresh to generate one.';
            cardContainer.appendChild(message);
            return;
          }

          const section = document.createElement('section');
          section.className = 'space-y-3 rounded-2xl border border-sky-200 bg-sky-50 p-6 shadow-sm';

          const title = document.createElement('h2');
          title.textContent = 'Suggested follow-up';
          title.className = 'text-lg font-semibold text-slate-900';
          section.appendChild(title);

          const urgency = document.createElement('p');
          urgency.className = 'text-sm font-semibold text-sky-800';
          urgency.textContent = `Urgency: ${match.urgency} / 10`;
          section.appendChild(urgency);

          const summary = document.createElement('p');
          summary.className = 'text-base text-slate-800';
          summary.textContent = match.proposed_response;
          section.appendChild(summary);

          const rationale = document.createElement('p');
          rationale.className = 'text-sm text-slate-700';
          const rationaleLabel = document.createElement('strong');
          rationaleLabel.textContent = 'Why:';
          rationale.appendChild(rationaleLabel);
          rationale.append(` ${match.rationale}`);
          section.appendChild(rationale);

          const generated = document.createElement('p');
          generated.className = 'text-xs uppercase tracking-wide text-slate-500';
          generated.textContent = `Generated ${match.generated_label || match.generated_at}`;
          section.appendChild(generated);

          cardContainer.appendChild(section);
        };

        const handleResponse = (payload) => {
          const list = Array.isArray(payload?.recommendations) ? payload.recommendations : [];
          renderRecommendationsTable(list);
          renderSelectedRecommendation(list);
        };

        refreshForms.forEach((form) => {
          if (form.dataset.bound === 'true') {
            return;
          }
          form.dataset.bound = 'true';

          const endpoint = form.dataset.refreshEndpoint;
          const statusEndpoint = form.dataset.statusEndpoint;
          const button = form.querySelector('button');
          if (!endpoint || !statusEndpoint || !button) {
            return;
          }

          let pollTimer = null;
          let lastStart = 0;

          const cancelPoll = () => {
            if (pollTimer) {
              window.clearTimeout(pollTimer);
              pollTimer = null;
            }
          };

          const pollStatus = async () => {
            try {
              const response = await fetch(statusEndpoint, {
                method: 'GET',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
                cache: 'no-store',
              });
              if (!response.ok) {
                throw new Error(`Status request failed: ${response.status}`);
              }
              const payload = await response.json();
              const inProgress = Boolean(payload?.refresh_in_progress);
               button.dataset.refreshing = inProgress ? 'true' : 'false';
               handleResponse(payload);
              if (inProgress) {
                setStatus(payload?.message || 'Refreshing follow-ups…');
                pollTimer = window.setTimeout(pollStatus, POLL_INTERVAL_MS);
              } else {
                if (Date.now() - lastStart < POLL_INTERVAL_MS) {
                  pollTimer = window.setTimeout(pollStatus, 250);
                  return;
                }
                stopAnimation(button);
                cancelPoll();
                setStatus(payload?.message || 'Recommendations refreshed.', false);
              }
            } catch (error) {
              console.error('Failed to poll refresh status', error);
              stopAnimation(button);
              cancelPoll();
              setStatus('Failed to refresh follow-ups. Please try again.', true);
            }
          };

          const ensurePolling = () => {
            if (!pollTimer) {
              pollTimer = window.setTimeout(pollStatus, 0);
            }
          };

          if (button.dataset.refreshing === 'true') {
            startAnimation(button);
            lastStart = Date.now();
            ensurePolling();
          }

          form.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (intervals.has(button)) {
              return;
            }

            startAnimation(button);
            setStatus('Refreshing follow-ups…');
            lastStart = Date.now();
            ensurePolling();

            try {
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
              });

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || response.statusText);
              }

              const payload = await response.json();
              handleResponse(payload);
              const inProgress = Boolean(payload?.refresh_in_progress);
              button.dataset.refreshing = inProgress ? 'true' : 'false';
              const message = payload?.message || (inProgress ? 'Refreshing follow-ups…' : 'Recommendations refreshed.');
              setStatus(message, false);
              if (!inProgress) {
                stopAnimation(button);
                cancelPoll();
              } else {
                lastStart = Date.now();
                ensurePolling();
              }
            } catch (error) {
              console.error('Failed to refresh follow-ups', error);
              setStatus('Failed to refresh follow-ups. Please try again.', true);
              stopAnimation(button);
              cancelPoll();
            }
          });
        });
      });
    </script>
  </body>
</html>
