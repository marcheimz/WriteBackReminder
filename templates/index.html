<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>WriteBackReminder</title>
    <style>
      body { font-family: sans-serif; margin: 2rem auto; max-width: 720px; }
      header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
      h1 { margin: 0; }
      form { margin-bottom: 1.5rem; }
      label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
      input[type="text"], textarea { width: 100%; font-size: 1rem; padding: 0.4rem; }
      textarea { min-height: 7rem; }
      button { padding: 0.5rem 1rem; font-size: 1rem; }
      .actions { display: flex; align-items: center; gap: 0.75rem; }
      .actions form { margin: 0; }
      .recommendations-link { padding: 0.45rem 0.9rem; border: 1px solid #333; border-radius: 4px; text-decoration: none; color: #333; }
      .recommendations-link:hover { background: #333; color: #fff; }
      .loading-button { min-width: 9.5rem; }
      .errors { background: #ffefef; border: 1px solid #cc4444; color: #842222; padding: 0.75rem; margin-bottom: 1rem; }
      .recommendation { border: 1px solid #4a7ebb; background: #eef4ff; padding: 1rem; border-radius: 4px; margin: 1.5rem 0; }
      .recommendation h2 { margin-top: 0; }
      .recommendation .urgency { font-weight: 600; }
      .recommendation .generated { font-size: 0.9rem; color: #555; }
      .history { border-top: 1px solid #ddd; padding-top: 1rem; }
      .text-muted { color: #555; font-size: 0.9rem; }
      .history-entry { border: 1px solid #ccc; padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 4px; }
      .history-entry.note { background: #fff9e8; border-color: #e0b354; }
      .history-entry time { display: block; font-size: 0.85rem; color: #666; margin-bottom: 0.35rem; }
      .entry-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
      .entry-actions form { margin: 0; }
      .entry-actions a, .entry-actions button { font-size: 0.85rem; padding: 0.3rem 0.6rem; border-radius: 4px; border: 1px solid #444; background: #fff; color: #333; text-decoration: none; cursor: pointer; }
      .entry-actions a:hover, .entry-actions button:hover { background: #333; color: #fff; }
      .people { margin-bottom: 1rem; }
      .people a { display: inline-block; margin: 0 0.5rem 0.5rem 0; padding: 0.35rem 0.65rem; border: 1px solid #666; border-radius: 4px; text-decoration: none; color: inherit; }
      .people a.active { background: #333; color: #fff; }
    </style>
  </head>
  <body data-user-email="{{ active_user_email }}" data-selected-person="{{ selected_person or '' }}">
    <header>
      <div>
        <h1>WriteBackReminder</h1>
        <p>
          Logged in as {{ active_user_name or active_user_email }}
          {% if active_user_name and active_user_email and active_user_name != active_user_email %}
          ({{ active_user_email }})
          {% endif %}
        </p>
      </div>
      <div class="actions">
        {% set is_refreshing = refresh_in_progress|default(False) %}
        <form
          method="post"
          action="{{ url_for('refresh_recommendations') }}"
          class="refresh-form"
          data-refresh-endpoint="{{ url_for('refresh_recommendations_api') }}"
          data-status-endpoint="{{ url_for('refresh_recommendations_status') }}"
        >
          <button
            type="submit"
            class="loading-button"
            data-loading-label="Refreshing"
            data-default-label="Refresh follow-ups"
            data-refreshing="{{ 'true' if is_refreshing else 'false' }}"
            {% if is_refreshing %}disabled{% endif %}
          >
            {% if is_refreshing %}Refreshing ...{% else %}Refresh follow-ups{% endif %}
          </button>
        </form>
        <a href="{{ url_for('recommendations_page') }}" class="recommendations-link">Follow-up suggestions</a>
        <form method="post" action="{{ url_for('logout') }}">
          <button type="submit">Switch user</button>
        </form>
      </div>
      <div class="refresh-status" data-refresh-status role="status" aria-live="polite"></div>
    </header>

    {% if errors %}
    <div class="errors">
      <ul>
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <section class="people">
      <strong>Known contacts:</strong>
      {% if known_people %}
        {% for person in known_people %}
        <a href="{{ url_for('conversations', person=person) }}" class="{% if person == selected_person %}active{% endif %}">{{ person }}</a>
        {% endfor %}
      {% else %}
      <span>No past conversations yet.</span>
      {% endif %}
    </section>

    <section>
      <form method="post" action="{{ url_for('log_conversation') }}" id="log-form">
        <label for="person">Who did you speak with?</label>
        <input
          type="text"
          id="person"
          name="person"
          list="known-people"
          value="{{ selected_person or '' }}"
          placeholder="Type a name"
          autocomplete="off"
          required
        />
        <datalist id="known-people">
          {% for person in known_people %}
          <option value="{{ person }}">{{ person }}</option>
          {% endfor %}
        </datalist>

        <label for="entry-type">Entry type</label>
        {% set selected_type = new_entry_type|default('conversation') %}
        <select id="entry-type" name="entry_type">
          <option value="conversation" {% if selected_type != 'note' %}selected{% endif %}>Conversation</option>
          <option value="note" {% if selected_type == 'note' %}selected{% endif %}>Note</option>
        </select>

        <label for="summary">Details</label>
        <textarea id="summary" name="summary" placeholder="What was discussed?" required>{{ draft_summary or '' }}</textarea>

        <button type="submit">Log conversation</button>
      </form>
    </section>

    <div data-recommendation-container>
      {% if recommendation %}
      <section class="recommendation">
        <h2>Suggested follow-up</h2>
        <p class="urgency">Urgency: {{ recommendation.urgency }} / 10</p>
        <p class="summary">{{ recommendation.proposed_response }}</p>
        <p class="rationale"><strong>Why:</strong> {{ recommendation.rationale }}</p>
        <p class="generated">Generated {{ recommendation.generated_at.strftime('%Y-%m-%d %H:%M UTC') }}</p>
      </section>
      {% elif selected_person %}
      <p class="text-muted">No AI follow-up yet. Refresh to generate one.</p>
      {% endif %}
    </div>

    {% if selected_person %}
    <section class="history">
      <h2>Conversation history with {{ selected_person }}</h2>
      {% if conversations %}
        {% for entry in conversations|reverse %}
        {% set is_note = entry.entry_type == 'note' %}
        <article class="history-entry {% if is_note %}note{% endif %}">
          <time datetime="{{ entry.timestamp.isoformat() }}">{{ entry.timestamp.strftime('%Y-%m-%d %H:%M UTC') }}</time>
          {% if is_note %}
          <p><strong>Note:</strong> {{ entry.summary }}</p>
          {% else %}
          <p>{{ entry.summary }}</p>
          {% endif %}
          <div class="entry-actions">
            <a href="{{ url_for('edit_entry', person=selected_person, entry=entry.id) }}">Edit</a>
            <form method="post" action="{{ url_for('delete_entry') }}" onsubmit="return confirm('Delete this entry?');">
              <input type="hidden" name="person" value="{{ selected_person }}" />
              <input type="hidden" name="entry_id" value="{{ entry.id }}" />
              <button type="submit">Delete</button>
            </form>
          </div>
        </article>
        {% endfor %}
      {% else %}
      <p>No conversations logged yet. Add a summary above to get started.</p>
      {% endif %}
    </section>
    {% endif %}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const body = document.body;
        const userEmail = body.dataset.userEmail;

        const logForm = document.getElementById('log-form');
        if (logForm) {
          const typeSelect = logForm.querySelector('#entry-type');
          const summaryField = logForm.querySelector('#summary');
          if (typeSelect && summaryField) {
            const placeholders = {
              conversation: 'What was discussed?',
              note: 'What do you want to remember or plan?'
            };
            const updatePlaceholder = () => {
              const key = (typeSelect.value || 'conversation').toLowerCase();
              summaryField.placeholder = placeholders[key] || placeholders.conversation;
            };
            updatePlaceholder();
            typeSelect.addEventListener('change', updatePlaceholder);
          }
        }

        const refreshForms = document.querySelectorAll('.refresh-form');
        if (!refreshForms.length) {
          return;
        }

        const statusEl = document.querySelector('[data-refresh-status]');
        const listContainer = document.querySelector('[data-recommendations-container]');
        const cardContainer = document.querySelector('[data-recommendation-container]');
        const selectedPerson = (document.body.dataset.selectedPerson || '').trim();
        const frames = ['.', '..', '...'];
        const intervals = new WeakMap();
        const POLL_INTERVAL_MS = 2500;

        const setStatus = (message, isError = false) => {
          if (!statusEl) {
            return;
          }
          statusEl.textContent = '';
          if (isError && message) {
            console.error(message);
          }
        };

        const startAnimation = (button) => {
          if (!button || intervals.has(button)) {
            return;
          }
          const defaultLabel = button.dataset.defaultLabel || button.textContent.trim() || 'Refresh follow-ups';
          button.dataset.defaultLabel = defaultLabel;
          button.dataset.animating = 'true';
          button.dataset.refreshing = 'true';
          const baseLabel = button.dataset.loadingLabel || 'Refreshing';
          let frameIndex = 0;
          const updateLabel = () => {
            button.textContent = `${baseLabel} ${frames[frameIndex]}`;
            frameIndex = (frameIndex + 1) % frames.length;
          };
          button.disabled = true;
          updateLabel();
          const intervalId = window.setInterval(updateLabel, 350);
          intervals.set(button, intervalId);
        };

        const stopAnimation = (button) => {
          if (!button) {
            return;
          }
          if (intervals.has(button)) {
            const id = intervals.get(button);
            window.clearInterval(id);
            intervals.delete(button);
          }
          button.dataset.animating = 'false';
          button.dataset.refreshing = 'false';
          const defaultLabel = button.dataset.defaultLabel || 'Refresh follow-ups';
          button.textContent = defaultLabel;
          button.disabled = false;
        };

        const renderRecommendationsTable = (items) => {
          if (!listContainer) {
            return;
          }
          listContainer.innerHTML = '';
          if (!items.length) {
            const empty = document.createElement('p');
            empty.className = 'text-muted';
            empty.textContent = 'No follow-up suggestions generated yet. Log conversations to see recommendations here.';
            listContainer.appendChild(empty);
            return;
          }

          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const headRow = document.createElement('tr');
          ['Person', 'Urgency', 'Proposed response', 'Rationale', 'Generated'].forEach((label) => {
            const th = document.createElement('th');
            th.textContent = label;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          items.forEach((item) => {
            const row = document.createElement('tr');

            const personCell = document.createElement('td');
            if (item.conversation_url) {
              const link = document.createElement('a');
              link.href = item.conversation_url;
              link.textContent = item.person;
              personCell.appendChild(link);
            } else {
              personCell.textContent = item.person;
            }
            row.appendChild(personCell);

            const urgencyCell = document.createElement('td');
            const urgencyClass = item.urgency >= 8 ? 'urgency-high' : item.urgency >= 5 ? 'urgency-medium' : 'urgency-low';
            urgencyCell.className = urgencyClass;
            urgencyCell.textContent = `${item.urgency}/10`;
            row.appendChild(urgencyCell);

            const responseCell = document.createElement('td');
            responseCell.textContent = item.proposed_response;
            row.appendChild(responseCell);

            const rationaleCell = document.createElement('td');
            rationaleCell.textContent = item.rationale;
            row.appendChild(rationaleCell);

            const timestampCell = document.createElement('td');
            timestampCell.className = 'text-muted';
            timestampCell.textContent = item.generated_label || item.generated_at;
            row.appendChild(timestampCell);

            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          listContainer.appendChild(table);
        };

        const renderSelectedRecommendation = (items) => {
          if (!cardContainer || !selectedPerson) {
            return;
          }
          cardContainer.innerHTML = '';
          const match = items.find((item) => item.person === selectedPerson);
          if (!match) {
            const message = document.createElement('p');
            message.className = 'text-muted';
            message.textContent = 'No AI follow-up yet. Refresh to generate one.';
            cardContainer.appendChild(message);
            return;
          }

          const section = document.createElement('section');
          section.className = 'recommendation';

          const title = document.createElement('h2');
          title.textContent = 'Suggested follow-up';
          section.appendChild(title);

          const urgency = document.createElement('p');
          urgency.className = 'urgency';
          urgency.textContent = `Urgency: ${match.urgency} / 10`;
          section.appendChild(urgency);

          const summary = document.createElement('p');
          summary.className = 'summary';
          summary.textContent = match.proposed_response;
          section.appendChild(summary);

          const rationale = document.createElement('p');
          rationale.className = 'rationale';
          const rationaleLabel = document.createElement('strong');
          rationaleLabel.textContent = 'Why:';
          rationale.appendChild(rationaleLabel);
          rationale.append(` ${match.rationale}`);
          section.appendChild(rationale);

          const generated = document.createElement('p');
          generated.className = 'generated';
          generated.textContent = `Generated ${match.generated_label || match.generated_at}`;
          section.appendChild(generated);

          cardContainer.appendChild(section);
        };

        const handleResponse = (payload) => {
          const list = Array.isArray(payload?.recommendations) ? payload.recommendations : [];
          renderRecommendationsTable(list);
          renderSelectedRecommendation(list);
        };

        refreshForms.forEach((form) => {
          if (form.dataset.bound === 'true') {
            return;
          }
          form.dataset.bound = 'true';

          const endpoint = form.dataset.refreshEndpoint;
          const statusEndpoint = form.dataset.statusEndpoint;
          const button = form.querySelector('button');
          if (!endpoint || !statusEndpoint || !button) {
            return;
          }

          let pollTimer = null;
          let lastStart = 0;

          const cancelPoll = () => {
            if (pollTimer) {
              window.clearTimeout(pollTimer);
              pollTimer = null;
            }
          };

          const pollStatus = async () => {
            try {
              const response = await fetch(statusEndpoint, {
                method: 'GET',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
                cache: 'no-store',
              });
              if (!response.ok) {
                throw new Error(`Status request failed: ${response.status}`);
              }
              const payload = await response.json();
              const inProgress = Boolean(payload?.refresh_in_progress);
               button.dataset.refreshing = inProgress ? 'true' : 'false';
               handleResponse(payload);
              if (inProgress) {
                setStatus(payload?.message || 'Refreshing follow-ups…');
                pollTimer = window.setTimeout(pollStatus, POLL_INTERVAL_MS);
              } else {
                if (Date.now() - lastStart < POLL_INTERVAL_MS) {
                  pollTimer = window.setTimeout(pollStatus, 250);
                  return;
                }
                stopAnimation(button);
                cancelPoll();
                setStatus(payload?.message || 'Recommendations refreshed.', false);
              }
            } catch (error) {
              console.error('Failed to poll refresh status', error);
              stopAnimation(button);
              cancelPoll();
              setStatus('Failed to refresh follow-ups. Please try again.', true);
            }
          };

          const ensurePolling = () => {
            if (!pollTimer) {
              pollTimer = window.setTimeout(pollStatus, 0);
            }
          };

          if (button.dataset.refreshing === 'true') {
            startAnimation(button);
            lastStart = Date.now();
            ensurePolling();
          }

          form.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (intervals.has(button)) {
              return;
            }

            startAnimation(button);
            setStatus('Refreshing follow-ups…');
            lastStart = Date.now();
            ensurePolling();

            try {
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
              });

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || response.statusText);
              }

              const payload = await response.json();
              handleResponse(payload);
              const inProgress = Boolean(payload?.refresh_in_progress);
              button.dataset.refreshing = inProgress ? 'true' : 'false';
              const message = payload?.message || (inProgress ? 'Refreshing follow-ups…' : 'Recommendations refreshed.');
              setStatus(message, false);
              if (!inProgress) {
                stopAnimation(button);
                cancelPoll();
              } else {
                lastStart = Date.now();
                ensurePolling();
              }
            } catch (error) {
              console.error('Failed to refresh follow-ups', error);
              setStatus('Failed to refresh follow-ups. Please try again.', true);
              stopAnimation(button);
              cancelPoll();
            }
          });
        });
      });
    </script>
  </body>
</html>
